<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.product.mapper.IProductMapper">
	<insert id="productWrite" parameterType="com.product.dto.ProductDTO" 
        useGeneratedKeys="true" keyProperty="prod_id">
    INSERT INTO product
	    (prod_price, prod_stock, member_id, prod_cate, 
	    prod_content, prod_name)
    VALUES
	    (#{prod_price}, #{prod_stock}, #{member_id}, #{prod_cate}, 
	    #{prod_content}, #{prod_name})
	</insert>

	<select id="getTotalCount" resultType="int"
		parameterType="com.common.dto.ParameterDTO">

		SELECT COUNT(*) FROM product

		<if test="searchWord!=null and 
			!searchWord.equals('')">
			WHERE prod_name LIKE '%' || #{searchWord} || '%'
		</if>
	</select>


	<select id="selectProduct"
		parameterType="com.common.dto.ParameterDTO"
		resultType="com.product.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, pro.prod_id, prod_cate,
			prod_content, prod_name, filename
		FROM product pro
		LEFT JOIN product_img img
		ON pro.prod_id = img.prod_id AND img.main_idx = 1
		<if test="searchWords != null and !searchWords.equals('') ">
			WHERE
			<foreach collection="searchWords" item="sw" separator="or"
				open="(" close=")">
				pro.prod_name LIKE CONCAT('%', #{sw}, '%')
			</foreach>
		</if>
		ORDER BY prod_id DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select>
	
	<select id="selectBestProd"
		parameterType="com.common.dto.ParameterDTO"
		resultType="com.product.dto.ProductDTO">
		SELECT pro.prod_price, pro.prod_id, pro.prod_cate, pro.prod_name, img.filename
		FROM (
    		SELECT pr.*, pur.pur_count
		    FROM product pr
		    LEFT JOIN (
		        SELECT prod_id, COUNT(*) AS pur_count
		        FROM purchase
		        GROUP BY prod_id
   			) pur 
      		ON pr.prod_id = pur.prod_id
		    <if test="searchWords != null and !searchWords.equals('') ">
		        WHERE
		        <foreach collection="searchWords" item="sw" separator="or" open="(" close=")">
		            pr.prod_name LIKE CONCAT('%', #{sw}, '%')
		        </foreach>
		    </if>
		    ORDER BY pur.pur_count DESC
		    LIMIT #{pageSize} OFFSET #{offset}
		) pro
		LEFT JOIN product_img img
		ON pro.prod_id = img.prod_id 
		AND img.main_idx = 1
	</select>

	<select id="selectBestProdForLastWeek"
		parameterType="Long"
		resultType="com.product.dto.ProductDTO">
		SELECT pro.prod_id, prod_price, prod_name, filename
		FROM product pro
		INNER JOIN (
			SELECT prod_id, COUNT(*) AS pur_count
			FROM purchase 
			WHERE purc_date >= DATE_SUB(CURDATE(), INTERVAL 6 DAY)
			GROUP BY prod_id
			ORDER BY pur_count DESC
			LIMIT 3
			)pu 
			ON pro.prod_id = pu.prod_id
		LEFT JOIN product_img pi 
		ON pro.prod_id = pi.prod_id 
		AND pi.main_idx = 1
	</select>

	<select id="selectProductView" parameterType="Long"
		resultType="com.product.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, prod_id,
		prod_cate, prod_content, prod_name
		FROM product
		WHERE prod_id =	#{prod_id}
	</select>

	<!-- 나의상품목록 조회 -->
	<select id="selectMyprod" parameterType="Long"
		resultType="com.product.dto.ProductDTO">
		SELECT prod_price, prod_stock, member_id, prod_id,
		prod_cate, prod_content, prod_name
		FROM product
		WHERE member_id = ${member_id}
		ORDER BY prod_id DESC
	</select>

	<select id="selectMember_id" parameterType="Long"
		resultType="Long">
		SELECT member_id FROM product
		WHERE prod_id = #{prod_id}
	</select>

	<update id="productUpdate"
		parameterType="com.product.dto.ProductDTO">
		UPDATE product set
		prod_price = #{prod_price},
		prod_stock = #{prod_stock},
		prod_cate = #{prod_cate},
		prod_content = #{prod_content},
		prod_name = #{prod_name}
		WHERE prod_id = #{prod_id}
	</update>

	<delete id="productDelete" parameterType="Long">
		DELETE FROM product
		WHERE prod_id = #{prod_id}
	</delete>


</mapper>
   